From 3053941c696c7bf749f55c960fe1fa5695d8afa9 Mon Sep 17 00:00:00 2001
From: LordYuuma <lordyuuma@gmail.com>
Date: Sat, 12 Jun 2021 01:20:18 +0200
Subject: [PATCH] edopro: Respect YGOPRO environment paths.

* premake5.lua (environment-paths): New option.
* gframe/game.cpp (PopulateResourcesDirectories)[YGOPRO_ENVIRONMENT_PATHS]:
Load scripts from YGOPRO_SCRIPT_PATH.
Load pics from YGOPRO_IMAGE_PATH.  Fall back to local downloader.
* gframe/data_handler.cpp (LoadDatabases)[YGOPRO_ENVIRONMENT_PATHS]:
Load databases and LFLists from YGOPRO_DATA_PATH.
* gframe/deck_manager.cpp (LoadLFList)[YGOPRO_ENVIRONMENT_PATHS]:
Don't load local LFLists -- use those loaded by the DataHandler instead.
* gframe/premake5.lua (ygopro-config)[environment-paths]:
Define YGOPRO_ENVIRONMENT_PATHS.
* gframe/utils.h (NormalizePath): Allow absolute paths.
(PathForeach): New function.
* gframe/utils.cpp (PathForeach): Implement it.
* gframe/text_types.h (operator/): Override for path_string.
---
 gframe/data_handler.cpp | 22 +++++++++++++++++++---
 gframe/deck_manager.cpp |  2 ++
 gframe/game.cpp         | 26 ++++++++++++++++++++++++++
 gframe/premake5.lua     |  4 ++++
 gframe/text_types.h     | 16 +++++++++++++++-
 gframe/utils.cpp        | 10 ++++++++++
 gframe/utils.h          |  1 +
 premake5.lua            |  4 ++++
 8 files changed, 81 insertions(+), 4 deletions(-)

diff --git a/gframe/data_handler.cpp b/gframe/data_handler.cpp
index e67324d..ecb2965 100644
--- a/gframe/data_handler.cpp
+++ b/gframe/data_handler.cpp
@@ -17,20 +17,36 @@
 #include "Android/COSAndroidOperator.h"
 #include "Android/porting_android.h"
 #endif
+#include "deck_manager.h"
 
 namespace ygo {
 
 void DataHandler::LoadDatabases() {
-	if(Utils::FileExists(EPRO_TEXT("./cards.cdb"))) {
-		if(dataManager->LoadDB(EPRO_TEXT("./cards.cdb")))
-			WindBot::AddDatabase(EPRO_TEXT("./cards.cdb"));
+#ifdef YGOPRO_ENVIRONMENT_PATHS
+	const char* data_path_env = getenv("YGOPRO_DATA_PATH");
+	if(!data_path_env) return;
+	epro::path_string data_path_s = Utils::ToPathString(data_path_env);
+	ygo::Utils::PathForeach(
+		data_path_s,
+		[&](const epro::path_string& prefix) {
+			for (auto& file : Utils::FindFiles(prefix, { EPRO_TEXT("cdb") }))
+				if(dataManager->LoadDB(prefix / file))
+					WindBot::AddDatabase(prefix / file);
+			deckManager->LoadLFListSingle(prefix / EPRO_TEXT("lflist.conf"));
+			dataManager->LoadStrings(prefix / EPRO_TEXT("strings.conf"));
+		});
+#else
+	if(Utils::FileExists(EPRO_TEXT("cards.cdb"))) {
+		if(dataManager->LoadDB(EPRO_TEXT("cards.cdb")))
+			WindBot::AddDatabase(EPRO_TEXT("cards.cdb"));
 	}
 	for(auto& file : Utils::FindFiles(EPRO_TEXT("./expansions/"), { EPRO_TEXT("cdb") }, 2)) {
 		epro::path_string db = EPRO_TEXT("./expansions/") + file;
 		if(dataManager->LoadDB(db))
 			WindBot::AddDatabase(db);
 	}
 	LoadArchivesDB();
+#endif
 }
 void DataHandler::LoadArchivesDB() {
 	for(auto& archive : Utils::archives) {
diff --git a/gframe/deck_manager.cpp b/gframe/deck_manager.cpp
index c3af0f2..2174835 100644
--- a/gframe/deck_manager.cpp
+++ b/gframe/deck_manager.cpp
@@ -105,9 +105,11 @@ bool DeckManager::LoadLFListFolder(epro::path_stringview _path) {
 	return loaded;
 }
 void DeckManager::LoadLFList() {
+#ifndef YGOPRO_ENVIRONMENT_PATHS
 	LoadLFListSingle(EPRO_TEXT("./expansions/lflist.conf"));
 	LoadLFListSingle(EPRO_TEXT("./lflist.conf"));
 	LoadLFListFolder(EPRO_TEXT("./lflists/"));
+#endif
 	LFList nolimit;
 	nolimit.listName = L"N/A"; // N/A
 	nolimit.hash = 0;
diff --git a/gframe/game.cpp b/gframe/game.cpp
index 200948d..bd36302 100644
--- a/gframe/game.cpp
+++ b/gframe/game.cpp
@@ -3469,6 +3469,31 @@ void Game::UpdateUnzipBar(unzip_payload* payload) {
 	game->updateProgressBottom->setProgress(payload->percentage);
 }
 void Game::PopulateResourcesDirectories() {
+#ifdef YGOPRO_ENVIRONMENT_PATHS
+	const char* script_path_env = getenv("YGOPRO_SCRIPT_PATH");
+	if (script_path_env)
+		Utils::PathForeach(
+			Utils::ToPathString(script_path_env),
+			[this](const epro::path_string& prefix) {
+				epro::path_string script_dir = Utils::NormalizePath(prefix);
+				script_dirs.push_back(script_dir);
+				auto script_subdirs = Utils::FindSubfolders(script_dir);
+				script_dirs.insert(script_dirs.end(), script_subdirs.begin(), script_subdirs.end());
+			});
+	const char* image_path_env = getenv("YGOPRO_IMAGE_PATH");
+	if(image_path_env)
+		Utils::PathForeach(
+			Utils::ToPathString(image_path_env),
+			[this](const epro::path_string& prefix) {
+				epro::path_string image_dir = Utils::NormalizePath(prefix);
+				pic_dirs.push_back(image_dir);
+				cover_dirs.push_back(image_dir / EPRO_TEXT("cover/"));
+				field_dirs.push_back(image_dir / EPRO_TEXT("field/"));
+			});
+	pic_dirs.push_back(EPRO_TEXT("./pics/"));
+	cover_dirs.push_back(EPRO_TEXT("./pics/cover/"));
+	field_dirs.push_back(EPRO_TEXT("./pics/field/"));
+#else
 	script_dirs.push_back(EPRO_TEXT("./expansions/script/"));
 	auto expansions_subdirs = Utils::FindSubfolders(EPRO_TEXT("./expansions/script/"));
 	script_dirs.insert(script_dirs.end(), std::make_move_iterator(expansions_subdirs.begin()), std::make_move_iterator(expansions_subdirs.end()));
@@ -3485,6 +3510,7 @@ void Game::PopulateResourcesDirectories() {
 	field_dirs.push_back(EPRO_TEXT("./expansions/pics/field/"));
 	field_dirs.push_back(EPRO_TEXT("archives"));
 	field_dirs.push_back(EPRO_TEXT("./pics/field/"));
+#endif
 }
 
 void Game::PopulateLocales() {
diff --git a/gframe/premake5.lua b/gframe/premake5.lua
index 7cb0412..241e346 100644
--- a/gframe/premake5.lua
+++ b/gframe/premake5.lua
@@ -27,6 +27,10 @@ local ygopro_config=function(static_core)
 	if _OPTIONS["update-url"] then
 		defines { "UPDATE_URL=" .. _OPTIONS["update-url"] }
 	end
+	if _OPTIONS["environment-paths"] then
+		defines { "YGOPRO_ENVIRONMENT_PATHS" }
+	end
+
 	includedirs "../ocgcore"
 	links { "clzma", "freetype", "Irrlicht" }
 	filter "system:macosx"
diff --git a/gframe/text_types.h b/gframe/text_types.h
index 8bacb23..16ad20d 100644
--- a/gframe/text_types.h
+++ b/gframe/text_types.h
@@ -44,4 +44,18 @@ using stringview = basic_string_view<char>;
 using wstringview = basic_string_view<wchar_t>;
 }
 using namespace nonstd::literals;
-#endif /* TEXT_TYPES_H_ */
\ No newline at end of file
+inline epro::path_string operator/(const epro::path_string& base, epro::path_stringview subdir) {
+	if (base.empty() || base == EPRO_TEXT(".")) {
+		epro::path_string path(subdir);
+		return path;
+	}
+	else {
+		epro::path_string path(base);
+		if (base.back() != EPRO_TEXT('/'))
+			path += EPRO_TEXT("/");
+		path += epro::path_string(subdir);
+		return path;
+	}
+}
+
+#endif /* TEXT_TYPES_H_ */
diff --git a/gframe/utils.cpp b/gframe/utils.cpp
index 7ef084a..e9f4b7d 100644
--- a/gframe/utils.cpp
+++ b/gframe/utils.cpp
@@ -363,6 +363,16 @@ namespace ygo {
 		return true;
 	}
 
+	void Utils::PathForeach(epro::path_stringview path, const std::function<void(epro::path_string)>& cb)
+	{
+		// FIXME: should be ';' in WIN32 and WIN64.
+		static const epro::path_char path_sep = EPRO_TEXT(':');
+		std::basic_istringstream<epro::path_char> dirs(path.data());
+		epro::path_string dir;
+		while (std::getline(dirs, dir, path_sep))
+			cb(dir);
+	}
+
 	const epro::path_string& Utils::GetExePath() {
 		static const epro::path_string binarypath = []()->epro::path_string {
 #ifdef _WIN32
diff --git a/gframe/utils.h b/gframe/utils.h
index d242363..6fc2408 100644
--- a/gframe/utils.h
+++ b/gframe/utils.h
@@ -74,6 +74,7 @@ namespace ygo {
 		static void CreateResourceFolders();
 		static void FindFiles(epro::path_stringview path, const std::function<void(epro::path_stringview, bool)>& cb);
 		static std::vector<epro::path_string> FindFiles(epro::path_stringview path, const std::vector<epro::path_stringview>& extensions, int subdirectorylayers = 0);
+		static void PathForeach(epro::path_stringview path, const std::function<void(epro::path_string)>& cb);
 		/** Returned subfolder names are prefixed by the provided path */
 		static std::vector<epro::path_string> FindSubfolders(epro::path_stringview path, int subdirectorylayers = 1, bool addparentpath = true);
 		static std::vector<int> FindFiles(irr::io::IFileArchive* archive, epro::path_stringview path, const std::vector<epro::path_stringview>& extensions, int subdirectorylayers = 0);
diff --git a/premake5.lua b/premake5.lua
index aa20c92..2eb82d8 100644
--- a/premake5.lua
+++ b/premake5.lua
@@ -60,6 +60,10 @@ newoption {
 	value = "url",
 	description = "API endpoint to check for updates from"
 }
+newoption {
+	trigger = "environment-paths",
+	description = "Read databases, scripts and images from YGOPRO_*_PATH"
+}
 workspace "ygo"
 	location "build"
 	language "C++"
--
libgit2 1.3.0

